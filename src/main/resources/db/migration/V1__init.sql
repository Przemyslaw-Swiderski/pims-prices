SET REFERENTIAL_INTEGRITY TRUE;

CREATE TABLE IF NOT EXISTS roles (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(20) NOT NULL
    );

CREATE TABLE IF NOT EXISTS users (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    username VARCHAR(20) NOT NULL,
    email VARCHAR(50) NOT NULL,
    firstname VARCHAR(120) NOT NULL,
    surname VARCHAR(120) NOT NULL,
    password VARCHAR(120) NOT NULL,
    CONSTRAINT ukusername UNIQUE (username),
    CONSTRAINT ukemail UNIQUE (email)
    );

CREATE TABLE IF NOT EXISTS users_and_roles (
    user_id BIGINT NOT NULL,
    role_id BIGINT NOT NULL,
    PRIMARY KEY (role_id, user_id),
    CONSTRAINT fk_users_of_users_and_roles FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE,
    CONSTRAINT fk_roles_of_users_and_roles FOREIGN KEY (role_id) REFERENCES roles (id) ON DELETE CASCADE
    );

CREATE TABLE IF NOT EXISTS refresh_tokens (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT NOT NULL,
    token VARCHAR(255) NOT NULL,
    expiry_date TIMESTAMP WITH TIME ZONE NOT NULL,
    CONSTRAINT fk_users_of_refresh_tokens FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE
    );

CREATE SEQUENCE IF NOT EXISTS refresh_tokens_seq START WITH 1 INCREMENT BY 50;

CREATE TABLE IF NOT EXISTS products (
    id VARCHAR(255) PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    ean VARCHAR(255) NOT NULL
);

CREATE TABLE IF NOT EXISTS prices (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    product_id VARCHAR(255),
    price NUMERIC(38,2),
    currency VARCHAR(255),
    CONSTRAINT fk_products FOREIGN KEY (product_id) REFERENCES products (id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS prices_categories (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255)
);

CREATE TABLE IF NOT EXISTS prices_and_prices_categories (
    price_id BIGINT NOT NULL,
    prices_category_id BIGINT NOT NULL,
    PRIMARY KEY (price_id, prices_category_id),
    CONSTRAINT fk_prices_of_prices_and_prices_categories FOREIGN KEY (price_id) REFERENCES prices (id) ON DELETE CASCADE,
    CONSTRAINT fk_prices_categories_of_prices_and_prices_categories FOREIGN KEY (prices_category_id) REFERENCES prices_categories (id) ON DELETE CASCADE
);

INSERT INTO roles (id, name) VALUES
    (1, 'ROLE_ADMIN'),
    (2, 'ROLE_USER');

-- default password: supersecret
INSERT INTO users (id, username, email, firstname, surname, password) VALUES
    (1, 'First_Admin', 'first.admin@email.com', 'First', 'Admin', '$2a$10$iWsDHae39mjHg1C9GNdW1eoZ..1xDFv4t9F4bksMchSA.IGjwTgr6'),
    (2, 'First_User', 'first.user@email.com', 'First', 'User', '$2a$10$I/pXk016Q7aNK6jouidOWOoc0Vh13SVr87M35Ed.K5xGqTNcZO8Fu');

INSERT INTO users_and_roles (user_id, role_id) VALUES
    (1, 1),
    (2, 2);

INSERT INTO products (id, name, ean) VALUES
    ('550e8400-e29b-41d4-a716-446655440000', 'Smartphone X', '1234567890123'),
    ('660f9511-fd7a-4a2b-89e4-5b3cddfcb49a', 'Laptop Pro 15', '9876543210987');

INSERT INTO prices (id, product_id, price, currency) VALUES
    (1, '550e8400-e29b-41d4-a716-446655440000', 282.64, 'EUR'),
    (2, '660f9511-fd7a-4a2b-89e4-5b3cddfcb49a', 1451.32, 'USD');

INSERT INTO prices_categories (id, name) VALUES
    (1, 'Whole sale price'),
    (2, 'Retail price'),
    (3, 'Summer price'),
    (4, 'Winter price');

INSERT INTO prices_and_prices_categories (price_id, prices_category_id) VALUES
    (1, 2),
    (1, 3),
    (2, 1),
    (2, 3);

ALTER TABLE prices ALTER COLUMN id RESTART WITH 3;
ALTER TABLE prices_categories ALTER COLUMN id RESTART WITH 5;
ALTER TABLE roles ALTER COLUMN id RESTART WITH 3;
ALTER TABLE users ALTER COLUMN id RESTART WITH 3;
